<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Poki Pet</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { margin:0; font-family: 'Comic Sans MS', cursive, sans-serif; background:#f7f9fc; }
    header { background:#3daee9; color:#fff; padding:12px; text-align:center; font-size:20px; font-weight:bold; }
    .user-info { text-align:center; margin:10px 0; }
    h2 { margin:15px 0; text-align:center; }
    .grid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; padding:10px; }
    .card {
      background:#fff; border-radius:12px; box-shadow:0 3px 6px rgba(0,0,0,0.1);
      padding:10px; text-align:center;
    }
    .card.locked { background:#f3f3f3; color:#888; }
    .pet-emoji { font-size:32px; margin:6px; }
    .progress { height:8px; background:#eee; border-radius:5px; margin:6px 0; overflow:hidden; }
    .progress-bar { height:100%; width:0%; background:#4caf50; transition:width 0.3s; }
    button {
      background:#ffc107; border:none; padding:6px 12px; margin:6px 0; border-radius:20px;
      font-weight:bold; cursor:pointer;
    }
    button:disabled { background:#ccc; cursor:not-allowed; }
    nav {
      position:fixed; bottom:0; left:0; right:0; background:#3daee9; display:flex;
      justify-content:space-around; padding:6px 0; border-top:2px solid #2d8bb3;
    }
    nav button { background:none; border:none; color:#fff; font-size:12px; display:flex; flex-direction:column; align-items:center; }
    nav button span { font-size:18px; }
    .page { display:none; padding-bottom:70px; }
    .page.active { display:block; }
  </style>
</head>
<body>
  <header>Poki Pet</header>
  <div class="user-info">
    User: <span id="username"></span> | Coins: <span id="coins">0</span>
  </div>

  <!-- Farm -->
  <div id="farmPage" class="page active">
    <h2>My Farm</h2>
    <div id="farmSlots" class="grid"></div>
  </div>

  <!-- Shop -->
  <div id="shopPage" class="page">
    <h2>Shop - Buy New Animals</h2>
    <div id="shopList" class="grid"></div>
  </div>

  <!-- Inventory -->
  <div id="inventoryPage" class="page">
    <h2>Inventory</h2>
    <div id="inventoryList" class="grid"></div>
  </div>

  <!-- Deposit -->
  <div id="depositPage" class="page">
    <h2>Deposit</h2>
    <button onclick="deposit(1)">Deposit 1 USDT ‚Üí 10000 $POKI</button>
    <button onclick="deposit(10000)">Deposit 10000 $POKI</button>
  </div>

  <!-- Withdraw -->
  <div id="withdrawPage" class="page">
    <h2>Withdraw</h2>
    <input type="number" id="withdrawAmount" placeholder="Amount $POKI">
    <button onclick="withdraw()">Withdraw</button>
  </div>

  <!-- Footer Menu -->
  <nav>
    <button onclick="showPage('farmPage')"><span>üè°</span>Farm</button>
    <button onclick="showPage('shopPage')"><span>üõí</span>Shop</button>
    <button onclick="showPage('inventoryPage')"><span>üì¶</span>Inventory</button>
    <button onclick="showPage('depositPage')"><span>üí∞</span>Deposit</button>
    <button onclick="showPage('withdrawPage')"><span>üè¶</span>Withdraw</button>
  </nav>

<script>
/* === Supabase Init === */
const SUPABASE_URL = "https://nxveoqzeoiuuweypawdd.supabase.co"; 
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im54dmVvcXplb2l1dXdleXBhd2RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NDgxMDcsImV4cCI6MjA3MTQyNDEwN30.pnoJHATNksB5rRbHJjQvUSatn6HW79jfEdFoBRt0zAM";
const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

let tg = window.Telegram.WebApp;
tg.expand();
let tgUser = tg.initDataUnsafe?.user || { id: 999, username:"DevTester" };

let userId = tgUser.id;
let username = tgUser.username || tgUser.first_name;
document.getElementById("username").textContent = username;

let currentUser = {};
let petsList = [];
let userPets = [];
let farmSlots = 4;
let pendingSlot = null;

/* === Page Control === */
function showPage(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* === Load Data === */
async function loadData(){
  let { data: users } = await sb.from("users").select("*").eq("id", userId).single();
  currentUser = users;
  document.getElementById("coins").textContent = currentUser.coins;

  let { data: pets } = await sb.from("pets").select("*");
  petsList = pets;

  let { data: up } = await sb.from("user_pets").select("*, pets(*)").eq("user_id", userId);
  userPets = up;

  renderFarm();
  renderShop();
  renderInventory();
}

/* === Render Farm === */
function renderFarm(){
  const farmDiv = document.getElementById("farmSlots");
  farmDiv.innerHTML = "";
  for(let i=1;i<=farmSlots;i++){
    let pet = userPets.find(p=>p.slot===i);
    let card = document.createElement("div");
    card.className="card";
    if(pet){
      let petData = petsList.find(pp=>pp.id===pet.pet_id);
      let last = new Date(pet.last_claim);
      let now = new Date();
      let elapsed = Math.floor((now-last)/1000);
      let ready = elapsed >= petData.interval;
      let pct = Math.min(100, (elapsed/petData.interval)*100);
      card.innerHTML=`
        <div class="pet-emoji">${petData.emoji}</div>
        <div>${petData.name}</div>
        <div class="progress"><div class="progress-bar" style="width:${pct}%"></div></div>
        <button onclick="claim(${pet.id},${petData.reward},${petData.interval})" ${ready?"":"disabled"}>Claim +${petData.reward}</button><br>
        <button onclick="openInventoryForSlot(${i})">Replace</button>
      `;
    }else{
      card.innerHTML=`<div>Empty</div><button onclick="openInventoryForSlot(${i})">Add Pet</button>`;
    }
    farmDiv.appendChild(card);
  }
}

/* === Render Shop === */
function renderShop(){
  const shopDiv = document.getElementById("shopList");
  shopDiv.innerHTML="";
  petsList.forEach(p=>{
    let card=document.createElement("div");
    card.className="card";
    card.style.border="2px solid #3daee9";
    card.innerHTML=`
      <div class="pet-emoji">${p.emoji}</div>
      <div><b>${p.name}</b></div>
      <div>${p.price} $POKI</div>
      <div>Reward: ${p.reward} / ${p.interval}s</div>
      <button onclick="buyPet(${p.id},${p.price})">Buy</button>
    `;
    shopDiv.appendChild(card);
  });
}

/* === Render Inventory === */
function renderInventory(){
  const invDiv = document.getElementById("inventoryList");
  invDiv.innerHTML="";
  let invPets=userPets.filter(p=>!p.slot);
  if(invPets.length===0){ invDiv.innerHTML="No pets in inventory"; return;}
  invPets.forEach(p=>{
    let pd=petsList.find(pp=>pp.id===p.pet_id);
    let card=document.createElement("div");
    card.className="card";
    card.style.border="2px solid #ffc107";
    card.innerHTML=`
      <div class="pet-emoji">${pd.emoji}</div>
      <div><b>${pd.name}</b></div>
      <button onclick="placePet(${p.id})">Place</button>
    `;
    invDiv.appendChild(card);
  });
}

/* === Farm ‚Üî Inventory Actions === */
function openInventoryForSlot(slotId){
  pendingSlot = slotId;
  showPage("inventoryPage");
}

async function placePet(userPetId){
  if(!pendingSlot){ alert("Select farm slot first!"); return; }

  // kosongkan slot kalau sudah ada pet (replace)
  await sb.from("user_pets").update({slot:null}).eq("user_id",userId).eq("slot",pendingSlot);

  // assign pet baru ke slot
  await sb.from("user_pets").update({slot:pendingSlot,last_claim:new Date().toISOString()}).eq("id",userPetId);

  pendingSlot=null;
  loadData();
  showPage("farmPage");
}

/* === Claim === */
async function claim(userPetId,reward,interval){
  let now=new Date();
  await sb.from("user_pets").update({last_claim: now}).eq("id",userPetId);
  await sb.from("users").update({coins: currentUser.coins+reward}).eq("id",userId);
  currentUser.coins+=reward;
  document.getElementById("coins").textContent=currentUser.coins;
  loadData();
}

/* === Buy Pet === */
async function buyPet(petId,price){
  if(currentUser.coins<price){alert("Not enough coins");return;}
  await sb.from("users").update({coins:currentUser.coins-price}).eq("id",userId);
  await sb.from("user_pets").insert([{user_id:userId,pet_id:petId,slot:null,last_claim:new Date()}]);
  currentUser.coins-=price;
  loadData();
}

/* === Deposit / Withdraw === */
async function deposit(amount){
  await sb.from("users").update({coins:currentUser.coins+10000}).eq("id",userId);
  currentUser.coins+=10000;
  loadData();
}
async function withdraw(){
  let amt=parseInt(document.getElementById("withdrawAmount").value);
  if(amt<=0||currentUser.coins<amt){alert("Invalid");return;}
  await sb.from("users").update({coins:currentUser.coins-amt}).eq("id",userId);
  currentUser.coins-=amt;
  loadData();
}

loadData();
</script>
</body>
</html>
