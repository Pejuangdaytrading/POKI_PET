<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Poki Pet - Crypto Animal Farm</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f4f4; }
    header { background: #4CAF50; color: white; padding: 10px; text-align: center; }
    .user-info { background:#e0ffe0; padding:8px; font-size:14px; border-bottom:1px solid #ccc; }
    .balance { margin: 10px; font-weight: bold; }
    .menu { position: fixed; bottom: 0; left: 0; right: 0; background: white;
      display: flex; justify-content: space-around; border-top: 1px solid #ccc; padding: 10px 0;
    }
    .menu button { border: none; background: none; font-size: 14px; }
    .page { display: none; padding: 20px; }
    .shop-item { background: white; padding: 10px; margin: 10px 0; border-radius: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>

  <!-- === HEADER === -->
  <header>
    Poki Pet - Crypto Animal Farm üêî
  </header>

  <!-- === USER INFO === -->
  <div id="userInfo" class="user-info">Loading user...</div>
  <div class="balance">Coins: <span id="coins">0</span></div>

  <!-- === FARM PAGE === -->
  <div id="farmPage" class="page" style="display:block;">
    <h3>My Farm</h3>
    <div id="farmSlots">Coming soon...</div>
  </div>

  <!-- === SHOP PAGE === -->
  <div id="shopPage" class="page">
    <h3>Shop - Coming soon</h3>
  </div>

  <!-- === DEPOSIT PAGE === -->
  <div id="depositPage" class="page">
    <h3>Deposit Coins</h3>
    <button onclick="deposit(100)">Deposit +100 Coins</button>
    <button onclick="deposit(500)">Deposit +500 Coins</button>
  </div>

  <!-- === WITHDRAW PAGE === -->
  <div id="withdrawPage" class="page">
    <h3>Withdraw Coins</h3>
    <input type="number" id="withdrawAmount" placeholder="Enter amount">
    <button onclick="withdraw()">Withdraw</button>
  </div>

  <!-- === MENU PAGE === -->
  <div id="menuPage" class="page">
    <h3>Menu (Coming Soon)</h3>
  </div>

  <!-- === BOTTOM MENU === -->
  <div class="menu">
    <button onclick="showTab('farmPage')">üêî Farm</button>
    <button onclick="showTab('shopPage')">üõí Shop</button>
    <button onclick="showTab('depositPage')">üí∞ Deposit</button>
    <button onclick="showTab('withdrawPage')">üè¶ Withdraw</button>
    <button onclick="showTab('menuPage')">‚ò∞ Menu</button>
  </div>

  <!-- === SCRIPT === -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>

  <script>
    /* === Supabase Init === */
    const supabaseUrl = "https://nxveoqzeoiuuweypawdd.supabase.co";   // ganti
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im54dmVvcXplb2l1dXdleXBhd2RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NDgxMDcsImV4cCI6MjA3MTQyNDEwN30.pnoJHATNksB5rRbHJjQvUSatn6HW79jfEdFoBRt0zAM";              // ganti
    const sb = supabase.createClient(supabaseUrl, supabaseKey);

    /* === Telegram Init === */
    let tg = window.Telegram.WebApp;
    tg.expand();

    let user = tg.initDataUnsafe?.user || { id: "999", first_name: "Tester" }; // fallback
    let telegramId = parseInt(user.id);
    let coins = 0;

    console.log("initDataUnsafe:", tg.initDataUnsafe);
    console.log("Parsed user:", user, "telegramId:", telegramId);

    /* === Init User from DB === */
    async function initUser() {
      let { data, error } = await sb
        .from("users")
        .select("*")
        .eq("id", telegramId)
        .single();

      console.log("Supabase SELECT:", data, error);

      if (error || !data) {
        let { data: newUser, error: errInsert } = await sb
          .from("users")
          .insert({ id: telegramId, username: user.first_name, coins: 0 })
          .select()
          .single();
        console.log("Supabase INSERT:", newUser, errInsert);
        coins = newUser ? newUser.coins : 0;
      } else {
        coins = data.coins;
      }

      document.getElementById("coins").textContent = coins;
      document.getElementById("userInfo").innerText =
        `User: ${user.first_name} (ID: ${telegramId})`;
    }

    initUser();

    /* === Deposit Function === */
    async function deposit(amount) {
      coins += amount;
      document.getElementById("coins").textContent = coins;

      await sb.from("users").update({ coins }).eq("id", telegramId);
      await sb.from("transactions").insert({ user_id: telegramId, type: "deposit", amount });

      console.log(`Deposited ${amount}, new balance: ${coins}`);
    }

    /* === Withdraw Function === */
    async function withdraw() {
      let amt = parseInt(document.getElementById("withdrawAmount").value);
      if (isNaN(amt) || amt <= 0) return alert("Enter valid amount!");
      if (coins < amt) return alert("Not enough coins!");

      coins -= amt;
      document.getElementById("coins").textContent = coins;

      await sb.from("users").update({ coins }).eq("id", telegramId);
      await sb.from("transactions").insert({ user_id: telegramId, type: "withdraw", amount: amt });

      console.log(`Withdrew ${amt}, new balance: ${coins}`);
      alert("Withdraw success (dummy, DB updated)");
    }

    /* === Utility === */
    function showTab(tab) {
      document.querySelectorAll(".page").forEach(p => p.style.display = "none");
      document.getElementById(tab).style.display = "block";
    }
  </script>
</body>
</html>

