<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Poki Pet</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="app-header">
    <h2>Poki Pet</h2>
    <div id="userInfo">Loading...</div>
    <div>Coins: <span id="coins">0</span></div>
  </header>

  <!-- FARM -->
  <div id="farmPage" class="page" style="display:block;">
    <h3>My Farm</h3>
    <div id="farmSlots" class="farm-area"></div>
  </div>

  <!-- SHOP -->
  <div id="shopPage" class="page">
    <h3>Shop - Buy New Animals</h3>
    <div id="shopItems" class="shop-grid"></div>
  </div>

  <!-- INVENTORY -->
  <div id="inventoryPage" class="page">
    <h3>Inventory</h3>
    <div id="inventoryItems"></div>
  </div>

  <!-- DEPOSIT -->
  <div id="depositPage" class="page">
    <h3>Deposit</h3>
    <button onclick="deposit(1)">Deposit 1 USDT ‚Üí 10000 $POKI</button>
    <button onclick="deposit(10000)">Deposit 10000 $POKI</button>
  </div>

  <!-- WITHDRAW -->
  <div id="withdrawPage" class="page">
    <h3>Withdraw</h3>
    <input type="number" id="withdrawAmount" placeholder="Amount $POKI">
    <button onclick="withdraw()">Withdraw</button>
  </div>

  <!-- MENU -->
  <div id="menuPage" class="page">
    <h3>Menu</h3>
    <p>@PokiPetBot</p>
  </div>

  <!-- FOOTER MENU -->
  <footer class="footer-menu">
    <button onclick="showTab('farmPage')">üè°<br><small>Farm</small></button>
    <button onclick="showTab('shopPage')">üõí<br><small>Shop</small></button>
    <button onclick="showTab('inventoryPage')">üì¶<br><small>Inventory</small></button>
    <button onclick="showTab('depositPage')">üí∞<br><small>Deposit</small></button>
    <button onclick="showTab('withdrawPage')">üè¶<br><small>Withdraw</small></button>
    <button onclick="showTab('menuPage')">‚öôÔ∏è<br><small>Menu</small></button>
  </footer>

  <!-- Telegram + Supabase -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const sb = supabase.createClient("https://nxveoqzeoiuuweypawdd.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im54dmVvcXplb2l1dXdleXBhd2RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NDgxMDcsImV4cCI6MjA3MTQyNDEwN30.pnoJHATNksB5rRbHJjQvUSatn6HW79jfEdFoBRt0zAM");
    const tgUser = tg.initDataUnsafe?.user || { id: 999, username: "DevTester" };

    let currentUser = null;
    let timers = {};

    async function loadUser() {
      let { data } = await sb.from("users").select("*").eq("id", tgUser.id).single();
      currentUser = data;
      if (!currentUser) return;

      document.getElementById("userInfo").innerText = `User: ${currentUser.username}`;
      document.getElementById("coins").innerText = currentUser.coins;
      loadFarm();
    }

    async function loadFarm() {
      let { data: userPets } = await sb.from("user_pets").select("*, pets(*)").eq("user_id", tgUser.id);
      let farmDiv = document.getElementById("farmSlots");
      farmDiv.innerHTML = "";

      for (let i = 1; i <= currentUser.farm_slots; i++) {
        let slotPet = userPets.find(p => p.slot === i);
        let div = document.createElement("div");
        div.className = "slot";

        if (!slotPet) {
          div.innerHTML = `<div>Empty</div><button onclick="openInventory(${i})">Add Pet</button>`;
        } else {
          let pet = slotPet.pets;
          let last = new Date(slotPet.last_claim);
          let now = new Date();
          let diff = Math.floor((now - last) / 1000);

          let progress = Math.min(100, (diff / pet.interval) * 100);
          let ready = diff >= pet.interval;

          div.innerHTML = `
            <div>${pet.emoji} ${pet.name}</div>
            <div class="progress"><div class="progress-bar" id="progress-${slotPet.id}" style="width:${progress}%"></div></div>
            <button id="claim-${slotPet.id}" ${!ready ? "disabled" : ""} 
              onclick="claim(${slotPet.id}, ${pet.reward})">
              Claim +${pet.reward}
            </button>
          `;

          startProgressTimer(slotPet.id, last, pet.interval);
        }
        farmDiv.appendChild(div);
      }

      // Locked slots
      for (let i = currentUser.farm_slots + 1; i <= 4; i++) {
        let cost = i * 500;
        let div = document.createElement("div");
        div.className = "slot locked";
        div.innerHTML = `<div>Locked</div><button onclick="unlockSlot(${i},${cost})">Unlock (${cost} $POKI)</button>`;
        farmDiv.appendChild(div);
      }
    }

    function startProgressTimer(userPetId, lastClaim, interval) {
      let progressBar = document.getElementById(`progress-${userPetId}`);
      let claimBtn = document.getElementById(`claim-${userPetId}`);

      function update() {
        let now = new Date();
        let diff = Math.floor((now - new Date(lastClaim)) / 1000);
        let progress = Math.min(100, (diff / interval) * 100);

        if (progressBar) progressBar.style.width = progress + "%";

        if (diff >= interval) {
          if (claimBtn) claimBtn.disabled = false;
          clearInterval(timers[userPetId]);
        }
      }

      if (timers[userPetId]) clearInterval(timers[userPetId]);
      update();
      timers[userPetId] = setInterval(update, 1000);
    }

    async function claim(userPetId, reward) {
      let newCoins = currentUser.coins + reward;
      await sb.from("users").update({ coins: newCoins }).eq("id", tgUser.id);
      await sb.from("user_pets").update({ last_claim: new Date().toISOString() }).eq("id", userPetId);

      currentUser.coins = newCoins;
      document.getElementById("coins").innerText = newCoins;
      loadFarm();
    }

    function showTab(tab) {
      document.querySelectorAll(".page").forEach(p => p.style.display = "none");
      document.getElementById(tab).style.display = "block";
    }

    loadUser();
  </script>
</body>
</html>
