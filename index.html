<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Poki Pet</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body>
  <header>
    <h1>Poki Pet</h1>
    <div id="user-info">Loading...</div>
  </header>

  <main id="content"></main>

  <footer>
    <div class="nav-item" onclick="showPage('farm')">üè°<br><span>Farm</span></div>
    <div class="nav-item" onclick="showPage('shop')">üõí<br><span>Shop</span></div>
    <div class="nav-item" onclick="showPage('inventory')">üì¶<br><span>Inventory</span></div>
    <div class="nav-item" onclick="showPage('deposit')">üí∞<br><span>Deposit</span></div>
    <div class="nav-item" onclick="showPage('withdraw')">üè¶<br><span>Withdraw</span></div>
    <div class="nav-item" onclick="showPage('menu')">‚öôÔ∏è<br><span>Menu</span></div>
  </footer>

  <script>
    // üîë Supabase Init
    const SUPABASE_URL = "https://nxveoqzeoiuuweypawdd.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im54dmVvcXplb2l1dXdleXBhd2RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NDgxMDcsImV4cCI6MjA3MTQyNDEwN30.pnoJHATNksB5rRbHJjQvUSatn6HW79jfEdFoBRt0zAM";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // üîë Telegram WebApp User
    const tg = window.Telegram.WebApp;
    tg.expand();
    let tgUser = tg.initDataUnsafe?.user;
    let userId = tgUser?.id;
    let username = tgUser?.username || ("tg" + userId);

    // ‚è≥ Global State
    let currentUser = null;

    // üöÄ Init
    async function init() {
      await loadUser();
      showPage("farm");
    }

    // üìå Load / Create User
    async function loadUser() {
      let { data: user, error } = await sb.from("users")
        .select("*").eq("id", userId).single();

      if (!user) {
        let { data: newUser } = await sb.from("users")
          .insert([{ id: userId, username, coins: 1000, farm_slots: 1 }])
          .select().single();
        user = newUser;
      }
      currentUser = user;
      updateUserInfo();
    }

    function updateUserInfo() {
      document.getElementById("user-info").innerHTML =
        `User: ${currentUser.username} | Coins: ${currentUser.coins}`;
    }

    // üìå Router
    function showPage(page) {
      if (page === "farm") renderFarm();
      if (page === "shop") renderShop();
      if (page === "inventory") renderInventory();
      if (page === "deposit") renderDeposit();
      if (page === "withdraw") renderWithdraw();
      if (page === "menu") renderMenu();
    }

    // üìå Farm
    async function renderFarm() {
  const farmSection = document.getElementById("farm-section");
  farmSection.innerHTML = "<h2>My Farm</h2><div class='farm-grid' id='farmGrid'></div>";

  const { data: userData } = await sb
    .from("users")
    .select("farm_slots")
    .eq("id", userId)
    .single();

  const { data: userPets } = await sb
    .from("user_pets")
    .select("slot, pet_id, last_claim, pets (name, emoji, reward, interval)")
    .eq("user_id", userId);

  const farmGrid = document.getElementById("farmGrid");
  farmGrid.innerHTML = "";

  for (let slot = 1; slot <= 4; slot++) {
    let card = document.createElement("div");
    card.className = "slot-card";

    if (slot <= userData.farm_slots) {
      // Slot terbuka
      const pet = userPets.find(p => p.slot === slot);

      if (pet) {
        // Ada pet di slot
        card.innerHTML = `
          <div class="pet-emoji">${pet.pets.emoji}</div>
          <div>${pet.pets.name}</div>
          <div class="soil"></div>
          <div class="progress"><div class="progress-bar" id="progress-${slot}"></div></div>
          <button class="btn-claim" id="claim-${slot}">Claim +${pet.pets.reward}</button>
        `;
        startTimer(slot, pet.last_claim, pet.pets.interval, pet.pets.reward, pet.pet_id);
      } else {
        // Slot kosong
        card.innerHTML = `
          <div class="soil"></div>
          <p>Empty</p>
          <button onclick="addPetToSlot(${slot})">Add Pet</button>
        `;
      }
    } else {
      // Slot locked
      let unlockCost = slot === 2 ? 500 : slot === 3 ? 1000 : 2000;
      card.innerHTML = `
        <div class="soil"></div>
        <p>Locked</p>
        <button onclick="unlockSlot(${slot}, ${unlockCost})">Unlock (${unlockCost} $POKI)</button>
      `;
    }

    farmGrid.appendChild(card);
  }
}

    // ‚è≥ Timer for claim
    function startTimer(slot, lastClaim, interval, reward, petId) {
  const claimBtn = document.getElementById(`claim-${slot}`);
  const progressBar = document.getElementById(`progress-${slot}`);

  function update() {
    const now = Math.floor(Date.now() / 1000);
    const last = Math.floor(new Date(lastClaim).getTime() / 1000);
    const elapsed = now - last;
    const percent = Math.min(100, (elapsed / interval) * 100);
    progressBar.style.width = percent + "%";

    if (elapsed >= interval) {
      claimBtn.disabled = false;
    } else {
      claimBtn.disabled = true;
      setTimeout(update, 1000);
    }
  }

  update();

  claimBtn.onclick = async () => {
    if (claimBtn.disabled) return;

    // Update coin + last_claim di DB
    await sb.rpc("claim_reward", { p_user_id: userId, p_pet_id: petId });

    // Refresh farm
    renderFarm();
    loadUser();
  };
}

    // üìå Shop
    async function renderShop() {
      const div = document.getElementById("content");
      div.innerHTML = "<h2>Shop - Buy New Animals</h2>";

      let { data: shopPets } = await sb.from("pets").select("*");
      const grid = document.createElement("div");
      grid.className = "shop-grid";

      shopPets.forEach(p => {
        const card = document.createElement("div");
        card.className = "pet-card";
        card.innerHTML = `
          <div class="pet-emoji">${p.emoji}</div>
          <h3>${p.name}</h3>
          <p>${p.price} $POKI<br>Reward: ${p.reward} / ${p.interval}s</p>
          <button onclick="buyPet(${p.id}, ${p.price})">Buy</button>
        `;
        grid.appendChild(card);
      });
      div.appendChild(grid);
    }

    async function buyPet(petId, price) {
      if (currentUser.coins < price) return alert("Not enough coins!");
      await sb.from("users").update({ coins: currentUser.coins - price }).eq("id", userId);
      await sb.from("user_pets").insert([{ user_id: userId, pet_id: petId }]);
      currentUser.coins -= price;
      updateUserInfo();
      alert("Pet bought! Check Inventory.");
    }

    // üìå Inventory
    async function renderInventory() {
      const div = document.getElementById("content");
      div.innerHTML = "<h2>Inventory</h2>";

      let { data: inv } = await sb.from("user_pets")
        .select("id, pet_id, pets(name, emoji)")
        .eq("user_id", userId)
        .is("slot", null);

      if (!inv || inv.length === 0) {
        div.innerHTML += "<p>No pets in inventory</p>";
      } else {
        const grid = document.createElement("div");
        grid.className = "shop-grid";
        inv.forEach(p => {
          const card = document.createElement("div");
          card.className = "pet-card";
          card.innerHTML = `
            <div class="pet-emoji">${p.pets.emoji}</div>
            <h3>${p.pets.name}</h3>
            <button onclick="placePet(${p.id})">Place</button>
          `;
          grid.appendChild(card);
        });
        div.appendChild(grid);
      }
    }

    async function placePet(userPetId) {
      // find empty slot
      let { data: pets } = await sb.from("user_pets").select("slot").eq("user_id", userId);
      let slots = pets.map(p => p.slot).filter(s => s != null);
      let nextSlot = 1;
      while (slots.includes(nextSlot)) nextSlot++;
      await sb.from("user_pets").update({ slot: nextSlot, last_claim: new Date().toISOString() }).eq("id", userPetId);
      renderFarm();
    }

    // üìå Deposit
    function renderDeposit() {
      const div = document.getElementById("content");
      div.innerHTML = "<h2>Deposit</h2>";
      div.innerHTML += `<button onclick="depositUSDT(1)">Deposit 1 USDT ‚Üí 10000 $POKI</button>`;
      div.innerHTML += `<button onclick="depositPOKI(10000)">Deposit 10000 $POKI</button>`;
    }

    async function depositUSDT(amount) {
      const poki = amount * 10000;
      await sb.from("users").update({ coins: currentUser.coins + poki }).eq("id", userId);
      await sb.from("transactions").insert([{ user_id: userId, type: "deposit", amount, currency: "USDT", poki_amount: poki, rate: 10000 }]);
      currentUser.coins += poki;
      updateUserInfo();
      alert("Deposit success!");
    }

    async function depositPOKI(poki) {
      await sb.from("users").update({ coins: currentUser.coins + poki }).eq("id", userId);
      await sb.from("transactions").insert([{ user_id: userId, type: "deposit", amount: poki, currency: "$POKI", poki_amount: poki, rate: 1 }]);
      currentUser.coins += poki;
      updateUserInfo();
      alert("Deposit success!");
    }

    // üìå Withdraw
    function renderWithdraw() {
      const div = document.getElementById("content");
      div.innerHTML = "<h2>Withdraw</h2>";
      div.innerHTML += `
        <input id="wdAmount" placeholder="Amount $POKI"/>
        <button onclick="withdraw()">Withdraw</button>
      `;
    }

    async function withdraw() {
      const amt = parseInt(document.getElementById("wdAmount").value);
      if (amt > currentUser.coins) return alert("Not enough coins!");
      await sb.from("users").update({ coins: currentUser.coins - amt }).eq("id", userId);
      await sb.from("transactions").insert([{ user_id: userId, type: "withdraw", amount: amt, currency: "$POKI", poki_amount: amt, rate: 1 }]);
      currentUser.coins -= amt;
      updateUserInfo();
      alert("Withdraw success!");
    }

    // üìå Menu
    function renderMenu() {
      const div = document.getElementById("content");
      div.innerHTML = "<h2>Menu (Coming Soon)</h2>";
      div.innerHTML += "<p>@PokiPetBot</p>";
    }

    init();
  </script>
</body>
</html>

