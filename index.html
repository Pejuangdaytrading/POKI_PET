<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Poki Pet</title>
  <link rel="stylesheet" href="style.css">

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <header>
    <h1>Poki Pet</h1>
    <p id="user-info">Loading...</p>
  </header>

  <!-- FARM -->
  <section id="farm" class="page active">
    <h2>My Farm</h2>
    <div id="farm-slots" class="farm-grid"></div>
  </section>

  <!-- SHOP -->
  <section id="shop" class="page">
    <h2>Shop - Buy New Animals</h2>
    <div id="shop-list" class="shop-grid"></div>
  </section>

  <!-- INVENTORY -->
  <section id="inventory" class="page">
    <h2>Inventory</h2>
    <div id="inventory-list" class="shop-grid"></div>
  </section>

  <!-- DEPOSIT -->
  <section id="deposit" class="page">
    <h2>Deposit</h2>
    <button onclick="depositUSDT(1)">Deposit 1 USDT ‚Üí 10000 $POKI</button>
    <button onclick="depositPOKI(10000)">Deposit 10000 $POKI</button>
  </section>

  <!-- WITHDRAW -->
  <section id="withdraw" class="page">
    <h2>Withdraw</h2>
    <input type="number" id="withdraw-amount" placeholder="Amount $POKI">
    <button onclick="withdraw()">Withdraw</button>
  </section>

  <!-- MENU -->
  <section id="menu" class="page">
    <h2>Menu</h2>
    <p>@PokiPetBot</p>
  </section>

  <!-- FOOTER NAV -->
  <footer class="footer">
    <div class="nav-item" onclick="showPage('farm')">üè°<span>Farm</span></div>
    <div class="nav-item" onclick="showPage('shop')">üõí<span>Shop</span></div>
    <div class="nav-item" onclick="showPage('inventory')">üì¶<span>Inventory</span></div>
    <div class="nav-item" onclick="showPage('deposit')">üí∞<span>Deposit</span></div>
    <div class="nav-item" onclick="showPage('withdraw')">üí∏<span>Withdraw</span></div>
    <div class="nav-item" onclick="showPage('menu')">‚öôÔ∏è<span>Menu</span></div>
  </footer>

<script>
/* -----------------------
   Supabase & Telegram Init
-------------------------*/
const sb = supabase.createClient("https://nxveoqzeoiuuweypawdd.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im54dmVvcXplb2l1dXdleXBhd2RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NDgxMDcsImV4cCI6MjA3MTQyNDEwN30.pnoJHATNksB5rRbHJjQvUSatn6HW79jfEdFoBRt0zAM");
const tg = window.Telegram.WebApp;
tg.expand();

let userId = tg.initDataUnsafe?.user?.id || 999;
let username = tg.initDataUnsafe?.user?.username || "DevTester";
let timers = {};

/* -----------------------
   Load User Info
-------------------------*/
async function loadUser() {
  const { data: user, error } = await sb.from("users").select("*").eq("id", userId).single();
  if (!user) {
    await sb.from("users").insert({ id: userId, username: username, coins: 1000, farm_slots: 1 });
    document.getElementById("user-info").innerText = `User: ${username} | Coins: 1000`;
  } else {
    document.getElementById("user-info").innerText = `User: ${user.username} | Coins: ${user.coins}`;
  }
  renderFarm();
  renderShop();
  renderInventory();
}

/* -----------------------
   FARM RENDER
-------------------------*/
async function renderFarm() {
  const farmDiv = document.getElementById("farm-slots");
  farmDiv.innerHTML = "";

  const { data: user } = await sb.from("users").select("farm_slots").eq("id", userId).single();
  const totalSlots = user.farm_slots;

  const { data: userPets } = await sb.from("user_pets")
    .select("id, slot, last_claim, pet_id, pets(name, emoji, reward, interval)")
    .eq("user_id", userId);

  const userPetsBySlot = {};
  userPets.forEach(p => userPetsBySlot[p.slot] = p);

  for (let i = 1; i <= 4; i++) {
    const slotDiv = document.createElement("div");
    slotDiv.className = "slot-card";

    if (i <= totalSlots) {
      if (userPetsBySlot[i]) {
        const pet = userPetsBySlot[i];
        slotDiv.innerHTML = `
          <div class="pet-emoji">${pet.pets.emoji}</div>
          <div>${pet.pets.name}</div>
          <div class="soil"></div>
          <div class="progress"><div id="progress-${pet.id}" class="progress-bar"></div></div>
          <button id="claim-${pet.id}" class="btn-claim">Loading...</button>
        `;
        const now = new Date();
        const lastClaim = new Date(pet.last_claim);
        const elapsed = Math.floor((now - lastClaim) / 1000);
        const remaining = Math.max(0, pet.pets.interval - elapsed);
        startTimer(pet.id, pet.pets.reward, pet.pets.interval, remaining);
      } else {
        slotDiv.innerHTML = `
          <div class="soil"></div>
          <p>Empty</p>
          <button class="btn-add">Add Pet</button>
        `;
      }
    } else {
      const cost = i === 3 ? 500 : 1000;
      slotDiv.innerHTML = `
        <div class="soil"></div>
        <p>Locked</p>
        <button onclick="unlockSlot(${i}, ${cost})">Unlock (${cost} $POKI)</button>
      `;
    }
    farmDiv.appendChild(slotDiv);
  }
}

/* -----------------------
   TIMER + CLAIM
-------------------------*/
function startTimer(userPetId, reward, interval, remaining) {
  const progressBar = document.getElementById(`progress-${userPetId}`);
  const claimBtn = document.getElementById(`claim-${userPetId}`);

  function updateUI(remain) {
    let pct = Math.min(100, ((interval - remain) / interval) * 100);
    progressBar.style.width = pct + "%";
    if (remain <= 0) {
      claimBtn.disabled = false;
      claimBtn.innerText = `Claim +${reward}`;
      claimBtn.onclick = () => claimReward(userPetId, reward, interval);
    } else {
      claimBtn.disabled = true;
      claimBtn.innerText = `${remain}s`;
    }
  }

  updateUI(remaining);

  if (timers[userPetId]) clearInterval(timers[userPetId]);
  timers[userPetId] = setInterval(() => {
    remaining -= 1;
    updateUI(remaining);
    if (remaining <= 0) clearInterval(timers[userPetId]);
  }, 1000);
}

async function claimReward(userPetId, reward, interval) {
  const { data: user } = await sb.from("users").select("coins").eq("id", userId).single();
  const newCoins = user.coins + reward;
  await sb.from("users").update({ coins: newCoins }).eq("id", userId);
  await sb.from("user_pets").update({ last_claim: new Date().toISOString() }).eq("id", userPetId);
  document.getElementById("user-info").innerText = `User: ${username} | Coins: ${newCoins}`;
  renderFarm();
}

/* -----------------------
   NAVIGATION
-------------------------*/
function showPage(id) {
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* -----------------------
   PLACEHOLDER SHOP/INV
-------------------------*/
async function renderShop() { /* kamu sudah punya */ }
async function renderInventory() { /* kamu sudah punya */ }

loadUser();
</script>
</body>
</html>
